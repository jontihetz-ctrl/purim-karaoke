<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>üé≠ Aish JHB Purim Karaoke 2026</title>
<style>
:root {
  --gold: #f5c518;
  --gold2: #e6a817;
  --purple: #5b1fa8;
  --purple2: #7c3aed;
  --deep: #1a0a2e;
  --card: #231040;
  --card2: #2d1555;
  --text: #fff;
  --muted: #a89ec9;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--deep);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: 90px;
}

/* Confetti dots background */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    radial-gradient(circle, #f5c51822 1px, transparent 1px),
    radial-gradient(circle, #7c3aed22 1px, transparent 1px);
  background-size: 30px 30px, 50px 50px;
  background-position: 0 0, 15px 15px;
  pointer-events: none;
  z-index: 0;
}

/* Header */
.header {
  background: linear-gradient(135deg, #5b1fa8 0%, #7c3aed 50%, #a855f7 100%);
  padding: 0;
  position: sticky; top: 0; z-index: 100;
  border-bottom: 3px solid var(--gold);
  box-shadow: 0 4px 24px rgba(91,31,168,0.6);
}
.header-inner {
  padding: 12px 16px 10px;
  position: relative;
}
.header-crown { font-size: 1.2rem; }
.header-title {
  font-size: 1.05rem;
  font-weight: 900;
  letter-spacing: 0.02em;
  color: var(--gold);
  text-shadow: 0 0 20px rgba(245,197,24,0.5);
}
.header-sub {
  font-size: 0.72rem;
  color: rgba(255,255,255,0.75);
  margin-top: 1px;
}
.header-decorations {
  position: absolute;
  right: 16px; top: 50%;
  transform: translateY(-50%);
  font-size: 1.5rem;
  letter-spacing: 2px;
}

/* Source bar */
.source-bar {
  display: flex;
  background: #160830;
  border-bottom: 2px solid #2d1555;
  padding: 0;
  position: sticky; top: 67px; z-index: 99;
}
.source-btn {
  flex: 1;
  padding: 10px 8px;
  border: none;
  background: transparent;
  color: var(--muted);
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}
.source-btn.active {
  color: var(--gold);
  border-bottom-color: var(--gold);
  background: rgba(245,197,24,0.06);
}

/* Search */
.search-wrap {
  padding: 10px 14px;
  background: #160830;
  position: sticky; top: 111px; z-index: 98;
  border-bottom: 1px solid #2d1555;
}
.search-inner { position: relative; }
.search-icon {
  position: absolute;
  left: 12px; top: 50%;
  transform: translateY(-50%);
  font-size: 0.9rem; opacity: 0.5;
}
.search-input {
  width: 100%;
  background: var(--card);
  border: 2px solid #3d1f7a;
  border-radius: 10px;
  color: #fff;
  font-size: 0.95rem;
  padding: 9px 12px 9px 36px;
  outline: none;
  transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--gold); }
.search-input::placeholder { color: #6b5a8a; }

/* Queue pill */
.queue-pill {
  position: fixed; top: 14px; right: 14px;
  background: var(--gold);
  color: #1a0a2e;
  border-radius: 20px;
  padding: 3px 10px;
  font-size: 0.72rem;
  font-weight: 800;
  z-index: 200;
  display: none;
}

/* Sections */
.section { padding: 14px 14px 0; position: relative; z-index: 1; }
.section-title {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--gold);
  font-weight: 800;
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}
.section-divider { height: 1px; background: #2d1555; margin: 14px 0 0; }

/* Genre chips */
.cats {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding-bottom: 4px;
  margin-bottom: 4px;
  scrollbar-width: none;
}
.cats::-webkit-scrollbar { display: none; }
.cat-chip {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  cursor: pointer;
}
.cat-icon {
  width: 58px; height: 58px;
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.7rem;
  border: 2px solid transparent;
  transition: all 0.15s;
}
.cat-chip.selected .cat-icon {
  border-color: var(--gold);
  box-shadow: 0 0 12px rgba(245,197,24,0.4);
}
.cat-label { font-size: 0.65rem; color: var(--muted); text-align: center; }
.cat-chip.selected .cat-label { color: var(--gold); font-weight: 700; }

/* Horizontal cards */
.card-row {
  display: flex; gap: 10px;
  overflow-x: auto; padding-bottom: 8px;
  scrollbar-width: none;
}
.card-row::-webkit-scrollbar { display: none; }
.song-card {
  flex-shrink: 0; width: 115px;
  cursor: pointer;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid transparent;
  transition: border-color 0.15s, transform 0.1s;
  background: var(--card);
}
.song-card:active { transform: scale(0.96); }
.song-card.selected { border-color: var(--gold); box-shadow: 0 0 12px rgba(245,197,24,0.3); }
.song-card img, .song-card-placeholder {
  width: 100%; height: 115px; object-fit: cover; display: block;
}
.song-card-placeholder {
  background: linear-gradient(135deg, #2d1555, #5b1fa8);
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem;
}
.song-card-info { padding: 7px 8px; }
.song-card-title { font-size: 0.72rem; font-weight: 700; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.song-card-artist { font-size: 0.62rem; color: var(--muted); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* Artist grid */
.artist-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.artist-card { cursor: pointer; text-align: center; }
.artist-img, .artist-placeholder {
  width: 100%; aspect-ratio: 1;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #3d1f7a;
  transition: border-color 0.15s;
  display: block;
}
.artist-img:active, .artist-placeholder:active { border-color: var(--gold); }
.artist-placeholder {
  background: linear-gradient(135deg, #2d1555, #5b1fa8);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8rem;
}
.artist-name { font-size: 0.67rem; margin-top: 5px; color: var(--muted); line-height: 1.2; }

/* Song rows */
.song-list { display: flex; flex-direction: column; gap: 7px; }
.song-row {
  display: flex; align-items: center; gap: 10px;
  background: var(--card);
  border-radius: 10px;
  padding: 9px 11px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: border-color 0.15s;
}
.song-row.selected { border-color: var(--gold); background: #2d1555; }
.song-row-img, .song-row-placeholder {
  width: 42px; height: 42px;
  border-radius: 7px; object-fit: cover; flex-shrink: 0;
  display: block;
}
.song-row-placeholder {
  background: linear-gradient(135deg, #2d1555, #5b1fa8);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
}
.song-row-info { flex: 1; min-width: 0; }
.song-row-title { font-size: 0.88rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.song-row-artist { font-size: 0.73rem; color: var(--muted); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.badge {
  font-size: 0.62rem; padding: 2px 7px; border-radius: 5px;
  font-weight: 700; flex-shrink: 0;
}
.badge-jk { background: #3d1f7a; color: #c4a0ff; }
.badge-kf { background: #1a3060; color: #7aafff; }
.badge-duo { background: #1a4030; color: #7affc4; }

/* Add bar */
.add-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: #1e0d3a;
  border-top: 2px solid var(--gold);
  padding: 10px 14px 14px;
  z-index: 200;
  transition: transform 0.3s;
  box-shadow: 0 -8px 30px rgba(91,31,168,0.5);
}
.add-bar.hidden { transform: translateY(110%); }
.add-bar-song {
  font-size: 0.82rem; color: var(--muted);
  margin-bottom: 8px;
  display: flex; align-items: center; gap: 6px;
  overflow: hidden;
}
.add-bar-song strong { color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.add-bar-row { display: flex; gap: 8px; }
.name-input {
  flex: 1;
  background: var(--card);
  border: 2px solid #3d1f7a;
  border-radius: 10px;
  color: #fff;
  font-size: 1rem;
  padding: 9px 12px;
  outline: none;
}
.name-input:focus { border-color: var(--gold); }
.name-input::placeholder { color: #6b5a8a; }
.add-btn {
  padding: 9px 16px;
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  border: none; border-radius: 10px;
  color: #1a0a2e;
  font-size: 0.9rem; font-weight: 900;
  cursor: pointer; white-space: nowrap;
  box-shadow: 0 4px 14px rgba(245,197,24,0.4);
}
.add-btn:disabled { opacity: 0.35; box-shadow: none; }

/* Toast */
.toast {
  position: fixed; bottom: 85px; left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  color: #1a0a2e;
  padding: 11px 22px; border-radius: 30px;
  font-weight: 900; font-size: 0.9rem;
  opacity: 0; transition: opacity 0.3s;
  pointer-events: none; white-space: nowrap; z-index: 300;
}
.toast.show { opacity: 1; }

.no-results { text-align: center; color: #4a3a6a; padding: 40px; font-size: 0.9rem; }
.back-btn {
  background: none; border: none; color: var(--gold);
  font-size: 0.82rem; font-weight: 700; cursor: pointer;
  margin-bottom: 10px; padding: 0; display: block;
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:8px">
      <span class="header-crown">üëë</span>
      <div>
        <div class="header-title">AISH HATORAH JHB</div>
        <div class="header-sub">üé≠ Purim Karaoke 2026 ¬∑ Pick your song!</div>
      </div>
    </div>
    <div class="header-decorations">üé≠üéâ</div>
  </div>
</div>

<div class="queue-pill" id="queuePill"></div>

<div class="source-bar">
  <button class="source-btn active" onclick="setSource('jewish')" id="src-jewish">‚ú°Ô∏è Jewish</button>
  <button class="source-btn" onclick="setSource('secular')" id="src-secular">üåç Secular</button>
  <button class="source-btn" onclick="setSource('queue')" id="src-queue">üìã Queue</button>
</div>

<div class="search-wrap">
  <div class="search-inner">
    <span class="search-icon">üîç</span>
    <input class="search-input" id="searchInput" type="text" placeholder="Search songs or artists..." oninput="onSearch()" autocomplete="off">
  </div>
</div>

<div id="content"></div>

<div class="add-bar hidden" id="addBar">
  <div class="add-bar-song" id="addBarSong">üéµ <strong>Select a song</strong></div>
  <div class="add-bar-row">
    <input class="name-input" id="nameInput" type="text" placeholder="Your name..." maxlength="30" oninput="updateAddBtn()">
    <button class="add-btn" id="addBtn" disabled onclick="addToQueue()">üé§ Queue!</button>
  </div>
</div>
<div class="toast" id="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let currentSource = 'jewish';
let selectedSong = null;
let searchTimeout = null;
let currentCat = null;
let view = 'home';
let jkData = null, jkPopular = null, kfGenres = null;

let liveQueue = [];
let liveCurrent = null;

socket.on('queue_update', ({ queue, currentSong }) => {
  liveQueue = queue;
  liveCurrent = currentSong;
  const pill = document.getElementById('queuePill');
  if (queue.length > 0) { pill.textContent = queue.length + ' in queue'; pill.style.display = 'block'; }
  else pill.style.display = 'none';
  if (currentSource === 'queue') renderQueueView();
});

async function loadData() {
  [jkData, jkPopular, kfGenres] = await Promise.all([
    fetch('/api/catalogue/jk').then(r => r.json()),
    fetch('/api/catalogue/jk-popular').then(r => r.json()),
    fetch('/api/catalogue/kf-genres').then(r => r.json()),
  ]);
  renderHome();
}

function setSource(src) {
  currentSource = src;
  ['jewish','secular','queue'].forEach(s => document.getElementById('src-'+s).classList.toggle('active', s === src));
  document.getElementById('searchInput').value = '';
  document.getElementById('searchInput').style.display = src === 'queue' ? 'none' : '';
  document.querySelector('.search-icon').style.display = src === 'queue' ? 'none' : '';
  if (src === 'secular') currentCat = 'Top20';
  if (src === 'queue') { renderQueueView(); return; }
  view = 'home';
  renderHome();
}

function onSearch() {
  clearTimeout(searchTimeout);
  const q = document.getElementById('searchInput').value.trim();
  if (q.length < 2) { view = 'home'; renderHome(); return; }
  searchTimeout = setTimeout(() => doSearch(q), 250);
}

function doSearch(q) {
  const ql = q.toLowerCase();
  if (currentSource === 'jewish') {
    const results = jkData.filter(s =>
      s.title.toLowerCase().includes(ql) ||
      (s.title_hebrew && s.title_hebrew.toLowerCase().includes(ql)) ||
      s.artist.toLowerCase().includes(ql)
    ).slice(0, 80);
    renderSongList(results, 'Search Results');
  } else {
    fetch(`/api/search?q=${encodeURIComponent(q)}&source=karafun`)
      .then(r => r.json())
      .then(songs => renderSongList(songs, 'Search Results'));
  }
}

// ---- HOME ----
function renderHome() {
  if (currentSource === 'jewish') renderJewishHome();
  else renderSecularHome();
}

function renderJewishHome() {
  const artists = topJewishArtists();
  document.getElementById('content').innerHTML = `
    <div class="section" style="padding-top:14px">
      <div class="section-title">‚≠ê Popular Right Now</div>
      <div class="card-row">${jkPopular.slice(0,20).map(s => songCard(s)).join('')}</div>
    </div>
    <div class="section-divider"></div>
    <div class="section" style="padding-top:14px">
      <div class="section-title">üéôÔ∏è Browse by Artist</div>
      <div class="artist-grid">${artists.map(a => artistCard(a)).join('')}</div>
    </div>
    <div class="section-divider"></div>
    <div class="section" style="padding-top:14px">
      <div class="section-title">üÜï Latest Releases</div>
      <div class="song-list">${jkData.slice(0,30).map(s => songRow(s)).join('')}</div>
    </div>
  `;
}

const SECULAR_CATS = [
  { key:'Top20',      icon:'üèÜ', color:'#f5c518', label:'Top 20' },
  { key:'Pop',        icon:'üéµ', color:'#f72585', label:'Pop' },
  { key:'Rock',       icon:'üé∏', color:'#ef4444', label:'Rock' },
  { key:'Country',    icon:'ü§†', color:'#f59e0b', label:'Country' },
  { key:'RnB',        icon:'üé∑', color:'#8b5cf6', label:'R&B' },
  { key:'HipHop',     icon:'üé§', color:'#10b981', label:'Hip-Hop' },
  { key:'Dance',      icon:'üíÉ', color:'#06b6d4', label:'Dance' },
  { key:'Soundtrack', icon:'üé¨', color:'#f97316', label:'Movies' },
  { key:'Duet',       icon:'üë´', color:'#ec4899', label:'Duets' },
  { key:'Christmas',  icon:'üéÑ', color:'#22c55e', label:'Xmas' },
];

function renderSecularHome() {
  if (!currentCat) currentCat = 'Top20';
  const cats = SECULAR_CATS.map(c => `
    <div class="cat-chip ${currentCat===c.key?'selected':''}" onclick="showKFCat('${c.key}')">
      <div class="cat-icon" style="background:${c.color}22;border-color:${currentCat===c.key?c.color:c.color+'33'}">${c.icon}</div>
      <div class="cat-label">${c.label}</div>
    </div>`).join('');
  const songs = (kfGenres[currentCat]||[]).slice(0,50);
  const cat = SECULAR_CATS.find(c=>c.key===currentCat);
  document.getElementById('content').innerHTML = `
    <div class="section" style="padding-top:14px">
      <div class="cats">${cats}</div>
    </div>
    <div class="section-divider"></div>
    <div class="section" style="padding-top:14px">
      <div class="section-title">${cat?cat.icon+' '+cat.label:currentCat}</div>
      <div class="song-list">${songs.map(s=>songRow(s)).join('')}</div>
    </div>`;
}

function showKFCat(key) { currentCat = key; renderSecularHome(); }

function showArtistSongs(id, name) {
  const songs = jkData.filter(s => s.artist_id === id || s.artist === name);
  document.getElementById('content').innerHTML = `
    <div class="section" style="padding-top:14px">
      <button class="back-btn" onclick="renderHome()">‚Üê All Artists</button>
      <div class="section-title">üéôÔ∏è ${esc(name)} <span style="color:#4a3a6a;font-weight:400">(${songs.length})</span></div>
      <div class="song-list">${songs.slice(0,100).map(s=>songRow(s)).join('')}</div>
    </div>`;
}

function renderSongList(songs, title) {
  document.getElementById('content').innerHTML = `
    <div class="section" style="padding-top:14px">
      <div class="section-title">${esc(title)} <span style="color:#4a3a6a;font-weight:400">(${songs.length})</span></div>
      ${songs.length ? `<div class="song-list">${songs.slice(0,100).map(s=>songRow(s)).join('')}</div>` : '<div class="no-results">No songs found üé≠</div>'}
    </div>`;
}

function renderQueueView() {
  const now = liveCurrent;
  const queue = liveQueue;
  let html = `<div class="section" style="padding-top:14px">`;

  if (now) {
    html += `
      <div class="section-title">üéôÔ∏è Now Singing</div>
      <div style="background:linear-gradient(135deg,#2d1555,#1a0a2e);border:2px solid var(--gold);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 0 20px rgba(245,197,24,0.15)">
        <div style="font-size:1.5rem;font-weight:900;color:var(--gold)">üé§ ${esc(now.singerName)}</div>
        <div style="font-size:1rem;font-weight:700;margin-top:4px">${esc(now.song.title)}</div>
        <div style="font-size:0.82rem;color:var(--muted)">${esc(now.song.artist||'')}</div>
      </div>`;
  }

  html += `<div class="section-title">üìã Up Next <span style="color:#4a3a6a;font-weight:400">(${queue.length})</span></div>`;

  if (!queue.length && !now) {
    html += `<div class="no-results">Queue is empty ‚Äî be the first! üé≠</div>`;
  } else {
    html += `<div class="song-list">` + queue.map((e, i) => `
      <div style="display:flex;align-items:center;gap:10px;background:var(--card);border-radius:10px;padding:10px 12px">
        <div style="font-size:1.2rem;font-weight:900;color:#3d1f7a;width:26px;text-align:center">${i+1}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:0.9rem;font-weight:700">üé§ ${esc(e.singerName)}</div>
          <div style="font-size:0.78rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(e.song.title)} ¬∑ ${esc(e.song.artist||'')}</div>
        </div>
        <span class="badge ${e.song.source==='jkaraoke'?'badge-jk':'badge-kf'}">${e.song.source==='jkaraoke'?'‚ú°Ô∏è':'üåç'}</span>
      </div>`).join('') + `</div>`;
  }

  html += `</div>`;
  document.getElementById('content').innerHTML = html;
}

// ---- ARTIST HELPERS ----
function topJewishArtists() {
  const map = {};
  jkData.forEach(s => {
    if (!map[s.artist]) map[s.artist] = { name:s.artist, id:s.artist_id, image:s.artistImage, count:0 };
    map[s.artist].count++;
    if (!map[s.artist].image && s.artistImage) map[s.artist].image = s.artistImage;
  });
  return Object.values(map).sort((a,b)=>b.count-a.count).slice(0,18);
}

function artistCard(a) {
  const imgHtml = a.image
    ? `<img class="artist-img" src="${esc(a.image)}" onerror="this.parentElement.innerHTML='<div class=\'artist-placeholder\'>üéôÔ∏è</div><div class=\'artist-name\'>${esc(a.name).replace(/'/g,"\\'")}</div>'">`
    : `<div class="artist-placeholder">üéôÔ∏è</div>`;
  return `<div class="artist-card" onclick="showArtistSongs(${a.id},'${esc(a.name).replace(/'/g,"\\'")}')">
    ${imgHtml}
    <div class="artist-name">${esc(a.name)}</div>
  </div>`;
}

// ---- SONG COMPONENTS ----
function songCard(s) {
  const img = s.albumCover || s.artistImage;
  const imgEl = img ? `<img src="${esc(img)}" style="width:100%;height:115px;object-fit:cover;display:block" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">` : '';
  const ph = `<div class="song-card-placeholder" ${img?'style="display:none"':''}>üéµ</div>`;
  return `<div class="song-card ${selectedSong&&selectedSong.id==s.id&&selectedSong.source==s.source?'selected':''}" onclick='selectSong(${JSON.stringify(s)})'>
    ${imgEl}${ph}
    <div class="song-card-info">
      <div class="song-card-title">${esc(s.title)}</div>
      <div class="song-card-artist">${esc(s.artist)}</div>
    </div>
  </div>`;
}

function songRow(s) {
  const img = s.albumCover || s.artistImage;
  const imgEl = img ? `<img class="song-row-img" src="${esc(img)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">` : '';
  const ph = `<div class="song-row-placeholder" ${img?'style="display:none"':''}>üéµ</div>`;
  const badge = s.source==='jkaraoke' ? `<span class="badge badge-jk">‚ú°Ô∏è</span>` : (s.duo?`<span class="badge badge-duo">Duet</span>`:`<span class="badge badge-kf">KF</span>`);
  const ytUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(s.title+' '+s.artist+' karaoke')}`;
  return `<div class="song-row ${selectedSong&&selectedSong.id==s.id&&selectedSong.source==s.source?'selected':''}" onclick='selectSong(${JSON.stringify(s)})'>
    ${imgEl}${ph}
    <div class="song-row-info">
      <div class="song-row-title">${esc(s.title)}</div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:2px">
        <div class="song-row-artist" style="flex:1">${esc(s.artist)}${s.year?' ¬∑ '+s.year:''}</div>
        <a href="${ytUrl}" target="_blank" onclick="event.stopPropagation()" style="color:#ff4444;font-size:0.7rem;text-decoration:none;flex-shrink:0;font-weight:700">‚ñ∂ Preview</a>
      </div>
    </div>
    ${badge}
  </div>`;
}

function selectSong(song) {
  selectedSong = song;
  document.querySelectorAll('.song-card,.song-row').forEach(el=>el.classList.remove('selected'));
  document.getElementById('addBar').classList.remove('hidden');
  document.getElementById('addBarSong').innerHTML = `üéµ <strong>${esc(song.title)}</strong> <span style="color:var(--muted)"> ‚Äî ${esc(song.artist)}</span>`;
  updateAddBtn();
  document.getElementById('nameInput').focus();
}

function updateAddBtn() {
  document.getElementById('addBtn').disabled = !document.getElementById('nameInput').value.trim() || !selectedSong;
}

async function addToQueue() {
  const name = document.getElementById('nameInput').value.trim();
  if (!name || !selectedSong) return;
  const btn = document.getElementById('addBtn');
  btn.disabled = true; btn.textContent = '...';
  const res = await fetch('/api/queue', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ song: selectedSong, singerName: name })
  });
  if (res.ok) {
    showToast(`üëë You're queued up, ${name}! Chag Sameach!`);
    document.getElementById('nameInput').value = '';
    document.getElementById('addBar').classList.add('hidden');
    selectedSong = null;
    document.querySelectorAll('.song-card,.song-row').forEach(el=>el.classList.remove('selected'));
  }
  btn.textContent = 'üé§ Queue!'; updateAddBtn();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 3500);
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

fetch('/api/queue').then(r=>r.json()).then(({queue})=>{
  const pill=document.getElementById('queuePill');
  if(queue.length>0){pill.textContent=queue.length+' in queue';pill.style.display='block';}
});
loadData();
</script>
</body>
</html>
